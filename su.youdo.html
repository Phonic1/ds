<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Place Value Math Tool - Units</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --square-size: 25px; } /* Increased default size for better visibility */
        body { font-family: 'Fredoka', sans-serif; background-color: #f4f7f9; display: flex; flex-direction: column; align-items: center; padding-top: 100px; padding-bottom: 150px; transition: background-color 0.3s ease; }
        .ui-panel { padding: 15px 25px; background-color: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); display: flex; align-items: center; gap: 15px; transition: background-color 0.3s ease, color 0.3s ease; }
        
        #student-info { position: fixed; top: 20px; right: 20px; z-index: 10; padding: 10px 15px; }

        #controls-wrapper { position: fixed; bottom: 20px; left: 20px; z-index: 10; display: flex; flex-direction: column; align-items: flex-start; gap: 10px; }
        #toggle-controls-button { background-color: #8e44ad; color: white; }
        #collapsible-controls { display: none; flex-direction: row; gap: 10px; align-items: flex-end; flex-wrap: wrap; }
        #collapsible-controls.visible { display: flex; }
        
        #teacher-tools, #controls, #color-changer { padding: 10px 15px; font-size: 0.9rem; }
        #slider { width: 100px; }
        #export-button { background-color: #3498db; color: white; }
        #print-button { background-color: #16a085; color: white; }

        .color-button { width: 30px; height: 30px; border-radius: 50%; border: 2px solid #ccc; cursor: pointer; transition: transform 0.2s ease; }
        .color-button:hover { transform: scale(1.1); }
        #main-container { display: flex; align-items: flex-end; justify-content: center; gap: 50px; margin-bottom: 30px; min-height: 200px; } /* Added min-height */
        #final-answer { flex-direction: column; gap: 12px; margin-top: 20px; position: relative; /* For confetti positioning */ }
        .grid-group { display: flex; flex-direction: column; align-items: center; gap: 15px; }
        #green-grids-wrapper { display: grid; grid-template-columns: repeat(3, auto); gap: 20px; } /* Now the only wrapper */
        .grid-container, .square { transition: background-color 0.2s ease, transform 0.2s ease, border-color 0.3s ease, outline 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .grid-container { display: grid; background-color: #ffffff; border: 1px solid #ccc; position: relative; }
        .square { width: var(--square-size); height: var(--square-size); box-sizing: border-box; border: 1px solid black; cursor: pointer; }
        .green { background-color: #2ecc71; transform: scale(1.05); }
        #name-input { font-size: 1.1rem; padding: 8px; width: 140px; border: 2px solid #ccc; border-radius: 8px; font-family: 'Fredoka', sans-serif; }
        #answer-input { font-size: 1.8rem; padding: 10px; width: 140px; text-align: center; border: 2px solid #ccc; border-radius: 8px; font-family: 'Fredoka', sans-serif; }
        .button { padding: 12px 24px; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: transform 0.1s, background-color 0.2s; }
        .button:active { transform: scale(0.95); }
        .button:disabled { background-color: #95a5a6; cursor: not-allowed; }
        #check-button { background-color: #27ae60; color: white; }
        #reset-button { background-color: #e67e22; color: white; }
        #feedback-message { font-size: 1.5rem; font-weight: bold; min-height: 30px; margin-top: 10px; text-align: center; position: relative; }
        .correct { color: #27ae60; }
        .incorrect { color: #c0392b; }
        
        body.dark-mode { color: #ecf0f1; }
        body.dark-mode .ui-panel { background-color: #34495e; color: #ecf0f1; }
        body.dark-mode .grid-container { background-color: #34495e; border-color: #7f8c8d; }
        body.dark-mode .square { border-color: #ecf0f1; }
        body.dark-mode input { background-color: #5d6d7e; color: #ecf0f1; border-color: #7f8c8d; }
        body.dark-mode .correct { color: #2ecc71; }
        body.dark-mode .incorrect { color: #e74c3c; }
        body.dark-mode .green, body.dark-mode .green:hover { background-color: #2ecc71; }

        .highlight { outline: 4px solid gold; outline-offset: 4px; transform: scale(1.15) !important; box-shadow: 0 0 25px gold; z-index: 100; }
        .confetti-container { position: absolute; top: -80px; left: 0; width: 100%; height: calc(100% + 150px); pointer-events: none; z-index: 1000; overflow: hidden; }
        .confetti { position: absolute; width: 10px; height: 10px; background-color: #f00; opacity: 0; animation: fall 3s linear forwards; }
        @keyframes fall {
            0% { opacity: 1; transform: translateY(0) rotateZ(0deg); }
            100% { opacity: 0; transform: translateY(400px) rotateZ(720deg); }
        }

        #print-container { display: none; }
        @media print {
            body > * { display: none !important; }
            #print-container { display: block !important; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            @page { margin: 1in; }
            .print-attempt-block { margin-top: 40px; padding-top: 20px; border-top: 1px solid #ccc; page-break-inside: avoid; }
        }
    </style>
</head>
<body>
    <div id="student-info" class="ui-panel">
        <label for="name-input" style="font-weight: bold;">Name:</label>
        <input type="text" id="name-input" placeholder="Your name">
    </div>

    <div id="controls-wrapper">
        <button id="toggle-controls-button" class="button">Controls</button>
        <div id="collapsible-controls">
            <!-- controls content -->
        </div>
    </div>

    <div id="main-container">
        <div class="grid-group">
             <div id="green-grids-wrapper"></div>
        </div>
    </div>

    <div id="final-answer" class="ui-panel">
        <!-- final answer content -->
    </div>

    <div id="print-container"></div>

    <script>
        const ELEVENLABS_API_KEY = 'sk_752823d799d70fcbca6c5e89f94c9e4a16423097299c5312';
        const ELEVENLABS_VOICE_ID = '21m00Tcm4TlvDq8ikWAM'; 
        let browserFemaleVoice = null;
        let progressLog = [];
        let currentCorrectValue = 0;

        // --- NUMBER TO WORDS CONVERTER ---
        function numberToWords(num) {
            const ones = ['', 'one', 'two', 'three', 'four', 'five', 'six', 'seven', 'eight', 'nine'];
            const teens = ['ten', 'eleven', 'twelve', 'thirteen', 'fourteen', 'fifteen', 'sixteen', 'seventeen', 'eighteen', 'nineteen'];
            const tens = ['', '', 'twenty', 'thirty', 'forty', 'fifty', 'sixty', 'seventy', 'eighty', 'ninety'];

            if (num === 0) return 'zero';
            if (num < 0) return 'minus ' + numberToWords(Math.abs(num));

            let words = '';

            if (Math.floor(num / 100) > 0) {
                words += ones[Math.floor(num / 100)] + ' hundred';
                num %= 100;
                if (num > 0) {
                    words += ' and ';
                }
            }

            if (num > 0) {
                if (num < 10) {
                    words += ones[num];
                } else if (num < 20) {
                    words += teens[num - 10];
                } else {
                    words += tens[Math.floor(num / 10)];
                    if (num % 10 > 0) {
                        words += ' ' + ones[num % 10];
                    }
                }
            }
            return words.trim();
        }

        // --- ROBUST SPEECH CONTROL SYSTEM ---
        let isSpeechLocked = false;
        let currentApiAudio = null;

        function forceStopAudio() {
            window.speechSynthesis.cancel(); // Force-stop browser TTS
            if (currentApiAudio) {
                currentApiAudio.pause();
                currentApiAudio.src = ''; // Detach source to prevent further loading
                currentApiAudio = null;
            }
            isSpeechLocked = false; // Release the lock
        }

        async function speak(text) {
            // 1. Wait until the lock is free. This prevents any overlap.
            while (isSpeechLocked) {
                await new Promise(resolve => setTimeout(resolve, 50));
            }

            // 2. Acquire the lock for ourselves.
            isSpeechLocked = true;

            return new Promise(async (resolve) => {
                const onEnd = () => {
                    isSpeechLocked = false; // 3. Release the lock when done.
                    resolve();
                };
                
                const onError = (err) => {
                    console.error("Speech Error:", err);
                    onEnd(); // Also release lock on error to prevent getting stuck.
                };

                // Fallback to browser TTS
                const fallbackSpeak = () => {
                    console.warn("Using browser's built-in TTS.");
                    const u = new SpeechSynthesisUtterance(text);
                    if (browserFemaleVoice) u.voice = browserFemaleVoice;
                    u.rate = 0.9;
                    u.onend = onEnd;
                    u.onerror = onError;
                    window.speechSynthesis.cancel();
                    window.speechSynthesis.speak(u);
                };

                // Try ElevenLabs API first
                if (ELEVENLABS_API_KEY && ELEVENLABS_VOICE_ID) {
                    try {
                        const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${ELEVENLABS_VOICE_ID}`, { method: 'POST', headers: { 'Accept': 'audio/mpeg', 'Content-Type': 'application/json', 'xi-api-key': ELEVENLABS_API_KEY }, body: JSON.stringify({ text, model_id: "eleven_multilingual_v2", voice_settings: { stability: 0.5, similarity_boost: 0.75 } }) });
                        if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                        
                        currentApiAudio = new Audio(URL.createObjectURL(await response.blob()));
                        currentApiAudio.onended = onEnd;
                        currentApiAudio.onerror = onError;
                        currentApiAudio.play();
                    } catch (error) {
                        console.error("API call failed, using fallback.", error);
                        fallbackSpeak();
                    }
                } else {
                    fallbackSpeak();
                }
            });
        }
        
        async function speakWithBrowser(text) {
            while (isSpeechLocked) {
                await new Promise(resolve => setTimeout(resolve, 50));
            }
            isSpeechLocked = true;

            return new Promise((resolve) => {
                const onEnd = () => {
                    isSpeechLocked = false; 
                    resolve();
                };
                const onError = (err) => {
                    console.error("Browser Speech Error:", err);
                    onEnd();
                };
                const u = new SpeechSynthesisUtterance(text);
                if (browserFemaleVoice) u.voice = browserFemaleVoice;
                u.rate = 0.9;
                u.onend = onEnd;
                u.onerror = onError;
                window.speechSynthesis.cancel();
                window.speechSynthesis.speak(u);
            });
        }


        function loadBrowserVoice() {
            const voices = window.speechSynthesis.getVoices();
            if (voices.length > 0) {
                browserFemaleVoice = voices.find(v => v.lang === 'en-GB' && v.name.includes('Female')) ||
                                   voices.find(v => v.lang === 'en-US' && v.name.includes('Female')) ||
                                   voices.find(v => v.lang.startsWith('en-'));
            }
        }
        // --- END OF SPEECH SYSTEM ---

        // --- MODIFIED: showGuidedCorrection now uses speakWithBrowser for counting ---
        async function showGuidedCorrection() {
            const pause = (ms) => new Promise(resolve => setTimeout(resolve, ms));
            const onesGrids = document.querySelectorAll('.square.grid-1x1.green');
            let currentCount = 0;
            
            await pause(200);

            for (const grid of onesGrids) {
                currentCount += 1;
                grid.classList.add('highlight');
                await speakWithBrowser(`${currentCount}`); // Use browser voice for counting
                await pause(100);
                grid.classList.remove('highlight');
                await pause(100);
            }
            
            await pause(400);
            const numberAsWords = numberToWords(currentCorrectValue);
            const finalMsg = `So the correct number is ${numberAsWords}. Let's try a new one!`;
            document.getElementById('feedback-message').textContent = `The answer was ${currentCorrectValue}.`;
            await speak(finalMsg); // Use API voice for the final summary message
            await pause(1000);
        }
        
        function triggerConfetti() {
            const finalAnswerPanel = document.getElementById('final-answer');
            let container = document.getElementById('confetti-container');
            if (container) container.remove(); 
            container = document.createElement('div');
            container.id = 'confetti-container';
            container.classList.add('confetti-container');
            finalAnswerPanel.appendChild(container);
            const colors = ['#27ae60', '#3498db', '#f1c40f', '#e74c3c', '#9b59b6'];
            const confettiCount = 60;
            for (let i = 0; i < confettiCount; i++) {
                const confetti = document.createElement('div');
                confetti.classList.add('confetti');
                confetti.style.left = `${Math.random() * 100}%`;
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = `${Math.random() * 0.5}s`;
                confetti.style.animationDuration = `${2 + Math.random() * 2}s`;
                const size = Math.floor(Math.random() * 6) + 6;
                confetti.style.width = `${size}px`;
                confetti.style.height = `${size}px`;
                container.appendChild(confetti);
            }
            setTimeout(() => { if (container) container.remove(); }, 5000);
        }

        function generateNewProblem() {
            const greenWrapper = document.getElementById('green-grids-wrapper');
            const answerInput = document.getElementById('answer-input');
            const feedbackMessage = document.getElementById('feedback-message');
            
            document.querySelectorAll('.green').forEach(el => el.classList.remove('green'));
            answerInput.value = '';
            feedbackMessage.textContent = '';
            feedbackMessage.className = '';

            // Generate a random number from 1 to 9
            currentCorrectValue = Math.floor(Math.random() * 9) + 1;
            const ones = currentCorrectValue;
            
            const allOneGrids = Array.from(greenWrapper.querySelectorAll('.square.grid-1x1'));
            const orderedOneGrids = [];
            const numCols = 3; 
            for (let col = 0; col < numCols; col++) {
                for (let row = numCols - 1; row >= 0; row--) {
                    const index = (row * numCols) + col;
                    if (allOneGrids[index]) orderedOneGrids.push(allOneGrids[index]);
                }
            }
            for (let i = 0; i < ones; i++) { if(orderedOneGrids[i]) orderedOneGrids[i].classList.add('green'); }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Updated: Removed difficulty selector
            document.getElementById('final-answer').innerHTML = `
                <label for="answer-input" style="font-size: 1.2rem; font-weight:bold;">What number do you see?</label>
                <input type="number" id="answer-input" placeholder="Type here">
                <div>
                    <button id="check-button" class="button">Check Answer</button>
                    <button id="reset-button" class="button">New Question</button>
                </div>
                <div id="feedback-message"></div>`;

            document.getElementById('collapsible-controls').innerHTML = `
                <div id="color-changer" class="ui-panel">
                    <button class="color-button" data-color="#f4f7f9" style="background-color: #f4f7f9;"></button>
                    <button class="color-button" data-color="#fcf8e8" style="background-color: #fcf8e8;"></button>
                    <button class="color-button" data-color="#2c3e50" style="background-color: #2c3e50;"></button>
                </div>
                <div id="teacher-tools" class="ui-panel">
                    <span>Logged: <b id="attempts-count">0</b></span>
                    <button id="export-button" class="button">Export</button>
                    <button id="print-button" class="button">Print</button>
                </div>
                <div id="controls" class="ui-panel">
                    <label for="slider">Size:</label>
                    <input type="range" id="slider" min="10" max="40" value="25">
                    <span id="slider-value">25px</span>
                </div>`;


            const nameInput = document.getElementById('name-input');
            const mainContainer = document.getElementById('main-container');
            const greenWrapper = document.getElementById('green-grids-wrapper');
            const slider = document.getElementById('slider');
            const sliderValue = document.getElementById('slider-value');
            const checkButton = document.getElementById('check-button');
            const resetButton = document.getElementById('reset-button');
            const colorChanger = document.getElementById('color-changer');
            const exportButton = document.getElementById('export-button');
            const toggleControlsButton = document.getElementById('toggle-controls-button');
            const collapsibleControls = document.getElementById('collapsible-controls');
            const printButton = document.getElementById('print-button');
            const printContainer = document.getElementById('print-container');
            
            if (window.speechSynthesis.onvoiceschanged !== undefined) {
                window.speechSynthesis.onvoiceschanged = loadBrowserVoice;
            }
            loadBrowserVoice();

            // Create only the 9 green squares
            for (let i = 0; i < 9; i++) {
                const gridG = document.createElement('div'); gridG.classList.add('square', 'grid-1x1');
                greenWrapper.appendChild(gridG);
            }
            
            slider.addEventListener('input', e => { document.documentElement.style.setProperty('--square-size', `${e.target.value}px`); sliderValue.textContent = `${e.target.value}px`; });
            
            resetButton.addEventListener('click', () => {
                forceStopAudio();
                generateNewProblem();
            });
            
            checkButton.addEventListener('click', async () => {
                forceStopAudio();

                const answerInput = document.getElementById('answer-input');
                const feedbackMessage = document.getElementById('feedback-message');
                const studentName = nameInput.value.trim() || 'Unnamed Student';
                const correctValue = currentCorrectValue;

                checkButton.disabled = true;
                resetButton.disabled = true;
                answerInput.disabled = true;

                if (answerInput.value.trim() === '') {
                    await speak("Please type a number.");
                    checkButton.disabled = false;
                    resetButton.disabled = false;
                    answerInput.disabled = false;
                    return;
                }
                const userValue = parseInt(answerInput.value);
                const isCorrect = correctValue === userValue;
                const record = { gridState: mainContainer.cloneNode(true), targetValue: correctValue, submittedValue: isNaN(userValue) ? 'N/A' : userValue, result: isCorrect ? 'Correct' : 'Incorrect' };
                progressLog.push(record);
                document.getElementById('attempts-count').textContent = progressLog.length;

                if (isCorrect) {
                    const spokenMsg = studentName !== 'Unnamed Student' ? `Correct! Fantastic work, ${studentName}!` : `Correct! Fantastic work!`;
                    feedbackMessage.textContent = "Correct! Well done!";
                    feedbackMessage.className = 'correct';
                    triggerConfetti();
                    await speak(spokenMsg);
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    generateNewProblem();
                } else {
                    const spokenMsg = `Good try! That wasn’t quite right. Let's count it out together.`;
                    feedbackMessage.textContent = `Not quite. Let's check...`;
                    feedbackMessage.className = 'incorrect';
                    await speak(spokenMsg);
                    await showGuidedCorrection(); 
                    generateNewProblem();
                }
                checkButton.disabled = false;
                resetButton.disabled = false;
                answerInput.disabled = false;
            });

            colorChanger.addEventListener('click', (event) => {
                const button = event.target.closest('.color-button');
                if (!button) return;
                document.body.style.backgroundColor = button.dataset.color;
                document.body.classList.toggle('dark-mode', button.dataset.color === '#2c3e50');
            });
            
            exportButton.addEventListener('click', () => {
                if (progressLog.length === 0) { alert('No progress has been logged yet.'); return; }
                const headers = ['Attempt #', 'Student Name', 'Target Value (Blocks)', 'Submitted Value (Typed)', 'Result'];
                let csvContent = headers.join(',') + '\n';
                progressLog.forEach((record, index) => {
                    const studentName = nameInput.value.trim() || 'Unnamed Student';
                    const row = [index + 1, `"${studentName}"`, record.targetValue, record.submittedValue, record.result];
                    csvContent += row.join(',') + '\n';
                });
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.setAttribute('href', URL.createObjectURL(blob));
                const studentName = (nameInput.value.trim() || 'student').replace(/ /g, '_');
                link.setAttribute('download', `progress_report_${studentName}_${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });

            toggleControlsButton.addEventListener('click', () => { collapsibleControls.classList.toggle('visible'); });
            
            printButton.addEventListener('click', () => {
                const studentName = nameInput.value.trim() || 'Unnamed Student';
                const date = new Date().toLocaleDateString();

                let worksheetHTML = `
                    <div style="font-family: 'Fredoka', sans-serif; padding: 20px;">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <h1 style="font-size: 24px; font-weight: bold; margin-bottom: 20px;">Place Value Worksheet</h1>
                            <p style="font-size: 18px; font-weight: bold; margin: 5px 0;">Name: ${studentName}</p>
                            <p style="font-size: 18px; font-weight: bold; margin: 5px 0;">Date: ${date}</p>
                        </div>
                `;

                if (progressLog.length === 0) {
                    worksheetHTML += `<p style="text-align: center; margin-top: 40px;">No attempts were logged. Here is the final grid state:</p>`;
                    worksheetHTML += mainContainer.outerHTML; // Show current state if no log
                } else {
                    progressLog.forEach((record, index) => {
                        const resultColor = record.result === 'Correct' ? '#27ae60' : '#c0392b';
                        worksheetHTML += `
                            <div class="print-attempt-block">
                                <h3 style="font-size: 20px; font-weight: bold; margin-bottom: 15px;">Attempt Log</h3>
                                <div style="display: flex; justify-content: space-around; font-size: 16px; margin-bottom: 20px;">
                                    <span><strong>Attempt #:</strong> ${index + 1}</span>
                                    <span><strong>Target Number (Blocks):</strong> ${record.targetValue}</span>
                                    <span><strong>Student's Answer:</strong> ${record.submittedValue}</span>
                                    <span style="color: ${resultColor}; font-weight: bold;">Result: ${record.result}</span>
                                </div>
                                ${record.gridState.outerHTML}
                            </div>
                        `;
                    });
                }
                
                worksheetHTML += `</div>`; // Close main wrapper
                printContainer.innerHTML = worksheetHTML;
                window.print();
            });

            generateNewProblem();
        });
    </script>
</body>
</html>