<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Place Value Math Tool</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --square-size: 15px; }
        body { font-family: 'Fredoka', sans-serif; background-color: #f4f7f9; display: flex; flex-direction: column; align-items: center; padding-top: 100px; padding-bottom: 150px; transition: background-color 0.3s ease; }
        .ui-panel { padding: 15px 25px; background-color: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); display: flex; align-items: center; gap: 15px; transition: background-color 0.3s ease, color 0.3s ease; }
        
        #student-info { position: fixed; top: 20px; right: 20px; z-index: 10; padding: 10px 15px; }

        #controls-wrapper { position: fixed; bottom: 20px; left: 20px; z-index: 10; display: flex; flex-direction: column; align-items: flex-start; gap: 10px; }
        #toggle-controls-button { background-color: #8e44ad; color: white; }
        #collapsible-controls { display: none; flex-direction: row; gap: 10px; align-items: flex-end; flex-wrap: wrap; }
        #collapsible-controls.visible { display: flex; }
        
        #teacher-tools, #controls, #color-changer { padding: 10px 15px; font-size: 0.9rem; }
        #slider { width: 100px; }
        #export-button { background-color: #3498db; color: white; }
        #print-button { background-color: #16a085; color: white; }

        .color-button { width: 30px; height: 30px; border-radius: 50%; border: 2px solid #ccc; cursor: pointer; transition: transform 0.2s ease; }
        .color-button:hover { transform: scale(1.1); }
        #main-container { display: flex; align-items: flex-end; justify-content: center; gap: 50px; margin-bottom: 30px; }
        #final-answer { flex-direction: column; gap: 12px; margin-top: 20px; }
        .grid-group { display: flex; flex-direction: column; align-items: center; gap: 15px; }
        #red-grids-wrapper, #green-grids-wrapper { display: grid; grid-template-columns: repeat(3, auto); gap: 20px; }
        #blue-grids-wrapper { display: flex; gap: 10px; }
        .grid-container, .square { transition: background-color 0.2s ease, transform 0.1s ease, border-color 0.3s ease; }
        .grid-container { display: grid; background-color: #ffffff; border: 1px solid #ccc; }
        .grid-10x10 { grid-template-columns: repeat(10, var(--square-size)); grid-template-rows: repeat(10, var(--square-size)); }
        .grid-1x10 { grid-template-columns: var(--square-size); grid-template-rows: repeat(10, var(--square-size)); }
        .square { width: var(--square-size); height: var(--square-size); box-sizing: border-box; border: 1px solid black; cursor: pointer; }
        .red { background-color: #e74c3c; transform: scale(1.05); }
        .blue { background-color: #3498db; transform: scale(1.05); }
        .green { background-color: #2ecc71; transform: scale(1.05); }
        #name-input { font-size: 1.1rem; padding: 8px; width: 140px; border: 2px solid #ccc; border-radius: 8px; font-family: 'Fredoka', sans-serif; }
        #answer-input { font-size: 1.8rem; padding: 10px; width: 140px; text-align: center; border: 2px solid #ccc; border-radius: 8px; font-family: 'Fredoka', sans-serif; }
        .button { padding: 12px 24px; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: transform 0.1s; }
        .button:active { transform: scale(0.95); }
        #check-button { background-color: #27ae60; color: white; }
        #reset-button { background-color: #c0392b; color: white; }
        #feedback-message { font-size: 1.5rem; font-weight: bold; min-height: 30px; margin-top: 10px; text-align: center;}
        .correct { color: #27ae60; }
        .incorrect { color: #c0392b; }
        body.dark-mode { color: #ecf0f1; }
        body.dark-mode .ui-panel { background-color: #34495e; color: #ecf0f1; }
        body.dark-mode .grid-container { background-color: #34495e; border-color: #7f8c8d; }
        body.dark-mode .square { border-color: #ecf0f1; }
        body.dark-mode input { background-color: #5d6d7e; color: #ecf0f1; border-color: #7f8c8d; }
        body.dark-mode .correct { color: #2ecc71; }
        body.dark-mode .incorrect { color: #e74c3c; }
        body.dark-mode .red, body.dark-mode .red:hover { background-color: #e74c3c; }
        body.dark-mode .blue, body.dark-mode .blue:hover { background-color: #3498db; }
        body.dark-mode .green, body.dark-mode .green:hover { background-color: #2ecc71; }

        #print-container { display: none; }

        @media print {
            body > * { display: none !important; }
            #print-container { display: block !important; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            @page { margin: 1in; }

            /* Styles for each attempt block on the worksheet */
            .print-attempt-block {
                margin-top: 40px;
                padding-top: 20px;
                border-top: 1px solid #ccc;
                /* This helps prevent a block from being split across two pages */
                page-break-inside: avoid; 
            }
        }
    </style>
</head>
<body>
    <div id="student-info" class="ui-panel">
        <label for="name-input" style="font-weight: bold;">Name:</label>
        <input type="text" id="name-input" placeholder="Your name">
    </div>

    <div id="controls-wrapper">
        <button id="toggle-controls-button" class="button">Controls</button>
        <div id="collapsible-controls">
            <div id="color-changer" class="ui-panel">
                <button class="color-button" data-color="#f4f7f9" style="background-color: #f4f7f9;"></button>
                <button class="color-button" data-color="#fcf8e8" style="background-color: #fcf8e8;"></button>
                <button class="color-button" data-color="#2c3e50" style="background-color: #2c3e50;"></button>
            </div>
            <div id="teacher-tools" class="ui-panel">
                <span>Logged: <b id="attempts-count">0</b></span>
                <button id="export-button" class="button">Export</button>
                <button id="print-button" class="button">Print</button>
            </div>
            <div id="controls" class="ui-panel">
                <label for="slider">Size:</label>
                <input type="range" id="slider" min="5" max="30" value="15">
                <span id="slider-value">15px</span>
            </div>
        </div>
    </div>

    <div id="main-container">
        <div class="grid-group"><div id="red-grids-wrapper"></div></div>
        <div class="grid-group"><div id="blue-grids-wrapper"></div></div>
        <div class="grid-group"><div id="green-grids-wrapper"></div></div>
    </div>

    <div id="final-answer" class="ui-panel">
        <label for="answer-input" style="font-size: 1.2rem; font-weight:bold;">What number did you make?</label>
        <input type="number" id="answer-input" placeholder="Type here">
        <div>
            <button id="check-button" class="button">Check Answer</button>
            <button id="reset-button" class="button">Reset</button>
        </div>
        <div id="feedback-message"></div>
    </div>

    <div id="print-container"></div>

    <script>
        const ELEVENLABS_API_KEY = 'sk_752823d799d70fcbca6c5e89f94c9e4a16423097299c5312';
        const ELEVENLABS_VOICE_ID = '21m00Tcm4TlvDq8ikWAM'; 
        let browserFemaleVoice = null;
        let progressLog = []; // Now stores objects with visual grid state

        function loadBrowserVoice() {
            const voices = window.speechSynthesis.getVoices();
            browserFemaleVoice = voices.find(v => v.lang === 'en-GB' && v.name.includes('Female')) ||
                               voices.find(v => v.lang === 'en-US' && v.name.includes('Female')) ||
                               voices.find(v => v.lang.startsWith('en-'));
        }
        window.speechSynthesis.onvoiceschanged = loadBrowserVoice;
        loadBrowserVoice();

        function numberToWords(num) {
            if (num === 0) return 'zero';
            const ones = ['', 'one', 'two', 'three', 'four', 'five', 'six', 'seven', 'eight', 'nine'];
            const teens = ['ten', 'eleven', 'twelve', 'thirteen', 'fourteen', 'fifteen', 'sixteen', 'seventeen', 'eighteen', 'nineteen'];
            const tens = ['', '', 'twenty', 'thirty', 'forty', 'fifty', 'sixty', 'seventy', 'eighty', 'ninety'];
            let words = [];
            if (num >= 100) { words.push(ones[Math.floor(num / 100)], 'hundred'); num %= 100; }
            if (words.length > 0 && num > 0) { words.push('and'); }
            if (num >= 20) { words.push(tens[Math.floor(num / 10)]); num %= 10; } 
            else if (num >= 10) { words.push(teens[num - 10]); num = 0; }
            if (num > 0) { words.push(ones[num]); }
            return words.join(' ');
        }

        document.addEventListener('DOMContentLoaded', function() {
            const nameInput = document.getElementById('name-input');
            const mainContainer = document.getElementById('main-container');
            const redWrapper = document.getElementById('red-grids-wrapper');
            const blueWrapper = document.getElementById('blue-grids-wrapper');
            const greenWrapper = document.getElementById('green-grids-wrapper');
            const slider = document.getElementById('slider');
            const sliderValue = document.getElementById('slider-value');
            const answerInput = document.getElementById('answer-input');
            const checkButton = document.getElementById('check-button');
            const resetButton = document.getElementById('reset-button');
            const feedbackMessage = document.getElementById('feedback-message');
            const colorChanger = document.getElementById('color-changer');
            const attemptsCount = document.getElementById('attempts-count');
            const exportButton = document.getElementById('export-button');
            const toggleControlsButton = document.getElementById('toggle-controls-button');
            const collapsibleControls = document.getElementById('collapsible-controls');
            const printButton = document.getElementById('print-button');
            const printContainer = document.getElementById('print-container');

            for (let i = 0; i < 9; i++) {
                const gridR = document.createElement('div'); gridR.classList.add('grid-container', 'grid-10x10');
                for (let j = 0; j < 100; j++) { const s = document.createElement('div'); s.classList.add('square'); gridR.appendChild(s); }
                redWrapper.appendChild(gridR);
                const gridB = document.createElement('div'); gridB.classList.add('grid-container', 'grid-1x10');
                for (let j = 0; j < 10; j++) { const s = document.createElement('div'); s.classList.add('square'); gridB.appendChild(s); }
                blueWrapper.appendChild(gridB);
                const gridG = document.createElement('div'); gridG.classList.add('square', 'grid-1x1');
                greenWrapper.appendChild(gridG);
            }

            async function speak(text) {
                const fallbackSpeak = () => { console.warn("Using browser's built-in TTS."); window.speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(text); if (browserFemaleVoice) u.voice = browserFemaleVoice; u.rate = 0.9; window.speechSynthesis.speak(u); };
                if (!ELEVENLABS_API_KEY) { fallbackSpeak(); return; }
                try {
                    const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${ELEVENLABS_VOICE_ID}`, { method: 'POST', headers: { 'Accept': 'audio/mpeg', 'Content-Type': 'application/json', 'xi-api-key': ELEVENLABS_API_KEY }, body: JSON.stringify({ text: text, model_id: "eleven_multilingual_v2", voice_settings: { stability: 0.5, similarity_boost: 0.75 } }) });
                    if (!response.ok) throw new Error(`API Error: ${response.status}`);
                    const audio = new Audio(URL.createObjectURL(await response.blob()));
                    audio.play();
                } catch (error) { console.error("API call failed:", error); fallbackSpeak(); }
            }
            
            redWrapper.addEventListener('click', e => e.target.closest('.grid-10x10')?.classList.toggle('red'));
            blueWrapper.addEventListener('click', e => e.target.closest('.grid-1x10')?.classList.toggle('blue'));
            greenWrapper.addEventListener('click', e => e.target.classList.contains('square') && e.target.classList.toggle('green'));
            slider.addEventListener('input', e => { document.documentElement.style.setProperty('--square-size', `${e.target.value}px`); sliderValue.textContent = `${e.target.value}px`; });
            resetButton.addEventListener('click', () => { document.querySelectorAll('.red, .blue, .green').forEach(el => el.classList.remove('red', 'blue', 'green')); answerInput.value = ''; feedbackMessage.textContent = ''; feedbackMessage.className = ''; });

            checkButton.addEventListener('click', () => {
                const studentName = nameInput.value.trim() || 'Unnamed Student';
                const hundreds = redWrapper.querySelectorAll('.red').length;
                const tens = blueWrapper.querySelectorAll('.blue').length;
                const ones = greenWrapper.querySelectorAll('.green').length;
                const correctValue = (hundreds * 100) + (tens * 10) + ones;
                const userValue = parseInt(answerInput.value);
                const isCorrect = correctValue === userValue;
                
                // UPDATED: Log the visual state of the grid
                const record = {
                    gridState: mainContainer.cloneNode(true), // Clone the DOM node
                    targetValue: correctValue,
                    submittedValue: isNaN(userValue) ? 'N/A' : userValue,
                    result: isCorrect ? 'Correct' : 'Incorrect'
                };
                progressLog.push(record);
                attemptsCount.textContent = progressLog.length;
                
                if (isNaN(userValue)) {
                    const msg = studentName !== 'Unnamed Student' ? `Please type a number, ${studentName}.` : "Please type a number.";
                    feedbackMessage.textContent = "Please type a number.";
                    feedbackMessage.className = 'incorrect';
                    speak(msg); return;
                }
                if (isCorrect) {
                    const numberInWords = numberToWords(correctValue);
                    const spokenMsg = studentName !== 'Unnamed Student' ? `Correct! Well done, ${studentName}! You made the number ${numberInWords}.` : `Correct! Well done! You made the number ${numberInWords}.`;
                    feedbackMessage.textContent = "Correct! Well done!";
                    feedbackMessage.className = 'correct';
                    speak(spokenMsg);
                } else {
                    const msg = studentName !== 'Unnamed Student' ? `Not quite, ${studentName}. Try again.` : "Not quite. Try again.";
                    feedbackMessage.textContent = "Not quite. Try again.";
                    feedbackMessage.className = 'incorrect';
                    speak(msg);
                }
            });

            colorChanger.addEventListener('click', (event) => {
                const button = event.target.closest('.color-button');
                if (!button) return;
                document.body.style.backgroundColor = button.dataset.color;
                document.body.classList.toggle('dark-mode', button.dataset.color === '#2c3e50');
            });
            
            exportButton.addEventListener('click', () => {
                if (progressLog.length === 0) { alert('No progress has been logged yet.'); return; }
                const headers = ['Attempt #', 'Student Name', 'Target Value (Blocks)', 'Submitted Value (Typed)', 'Result'];
                let csvContent = headers.join(',') + '\n';
                progressLog.forEach((record, index) => {
                    const studentName = nameInput.value.trim() || 'Unnamed Student';
                    const row = [index + 1, `"${studentName}"`, record.targetValue, record.submittedValue, record.result];
                    csvContent += row.join(',') + '\n';
                });
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.setAttribute('href', URL.createObjectURL(blob));
                const studentName = (nameInput.value.trim() || 'student').replace(/ /g, '_');
                link.setAttribute('download', `progress_report_${studentName}_${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });

            toggleControlsButton.addEventListener('click', () => {
                collapsibleControls.classList.toggle('visible');
            });

            // UPDATED: Print Worksheet functionality with visual log
            printButton.addEventListener('click', () => {
                const studentName = nameInput.value.trim() || 'Unnamed Student';
                const date = new Date().toLocaleDateString();

                let worksheetHTML = `
                    <div style="font-family: 'Fredoka', sans-serif; padding: 20px;">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <h1 style="font-size: 24px; font-weight: bold; margin-bottom: 20px;">Place Value Worksheet</h1>
                            <p style="font-size: 18px; font-weight: bold; margin: 5px 0;">Name: ${studentName}</p>
                            <p style="font-size: 18px; font-weight: bold; margin: 5px 0;">Date: ${date}</p>
                        </div>
                `;

                if (progressLog.length === 0) {
                    worksheetHTML += `<p style="text-align: center; margin-top: 40px;">No attempts were logged. Here is the final grid state:</p>`;
                    worksheetHTML += mainContainer.outerHTML; // Show current state if no log
                } else {
                    progressLog.forEach((record, index) => {
                        const resultColor = record.result === 'Correct' ? '#27ae60' : '#c0392b';
                        worksheetHTML += `
                            <div class="print-attempt-block">
                                <h3 style="font-size: 20px; font-weight: bold; margin-bottom: 15px;">Attempt Log</h3>
                                <div style="display: flex; justify-content: space-around; font-size: 16px; margin-bottom: 20px;">
                                    <span><strong>Attempt #:</strong> ${index + 1}</span>
                                    <span><strong>Target Number (Blocks):</strong> ${record.targetValue}</span>
                                    <span><strong>Student's Answer:</strong> ${record.submittedValue}</span>
                                    <span style="color: ${resultColor}; font-weight: bold;">Result: ${record.result}</span>
                                </div>
                                ${record.gridState.outerHTML}
                            </div>
                        `;
                    });
                }
                
                worksheetHTML += `</div>`; // Close main wrapper
                printContainer.innerHTML = worksheetHTML;
                window.print();
            });
        });
    </script>
</body>
</html>